{% extends 'base.html' %}

{% block title %}Завантаження відео{% endblock %}

{% block content %}
<section class="container text-center py-5">
    <h2>Про сайт</h2>
    <p>Цей сайт був створений, щоб допомогти вам швидко і зручно завантажувати відео з YouTube. Просто вставте посилання на відео, і ми зробимо все за вас!</p>
</section>

<!-- Download Section -->
<section class="download-section" id="download">
    <h2>Завантаження відео</h2>
    <p>Просто введіть посилку на відео, і ми завантажимо його для вас!</p>
    <form id="download-form" class="download-form">
        <div class="mb-3">
            <input type="text" class="form-control" name="url" id="url" placeholder="Вставте URL відео YouTube" required>
        </div>
        <button type="submit" class="btn btn-success btn-lg">Завантажити</button>
    </form>

    <!-- Progress bar container -->
    <div id="progress-container" style="display:none;">
        <div id="progress-bar">0%</div>
    </div>
    <div id="loading-text" class="loading-text" style="display:none;">
        Завантаження...
    </div>
    <div id="download-link" style="display:none;">
        <a href="#" id="download-button" class="btn btn-primary btn-lg" download>Завантажити файл</a>
    </div>
</section>
{% endblock %}

{% block styles %}
<style>
    #progress-container {
        position: relative;
        width: 100%;
        height: 30px;
        background-color: #f3f3f3;
        border-radius: 5px;
        overflow: hidden;
        margin-top: 20px;
    }

    #progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 0%;
        background-color: #28a745;
        text-align: center;
        line-height: 30px;
        color: #fff;
        font-weight: bold;
        transition: width 0.4s ease;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.1.3/socket.io.min.js"></script>
<script>
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const loadingText = document.getElementById('loading-text');
    const downloadLink = document.getElementById('download-link');
    const downloadButton = document.getElementById('download-button');

    const socket = io.connect('http://' + document.domain + ':' + location.port);

    socket.on('connect', function () {
        console.log("WebSocket connected");
        loadingText.style.display = 'none';  // Приховуємо "Завантаження..." після підключення
        progressContainer.style.display = 'none'; // Приховуємо прогрес-бар
    });

    socket.on('progress', function (data) {
    console.log("Received progress data:", data);

    if (data.progress !== undefined) {
        updateProgress(data.progress);
    }
    if (data.status) {
        loadingText.textContent = data.status;
    }
});
    socket.on('file_ready', function (data) {
        console.log("Received file_ready data:", data);

        if (data.task_id) {
            downloadButton.href = `/download?task_id=${data.task_id}`;
            downloadLink.style.display = 'block';  // Показуємо посилання для завантаження
            loadingText.style.display = 'none';   // Приховуємо текст "Завантаження..."
        } else {
            console.error("No task ID received.");
        }
    });

  // Update progress bar
  function updateProgress(percentage) {
    if (percentage === 0) {
        progressContainer.style.display = 'none';
        loadingText.style.display = 'block';
    } else {
        progressContainer.style.display = 'block';
        progressBar.style.width = percentage + '%';
        progressBar.textContent = Math.round(percentage) + '%';
    }
}
    const form = document.getElementById('download-form');
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        const url = document.getElementById('url').value;
        updateProgress(0);  // Початковий прогрес 0%
        loadingText.style.display = 'block';  // Показуємо текст "Завантаження..."
        progressContainer.style.display = 'none';  // Приховуємо прогрес-бар на початку
        socket.emit('start_download', { url: url });
    });

    socket.on('error', function (data) {
        alert("Сталася помилка: " + data.message);
    });
</script>
{% endblock %}
